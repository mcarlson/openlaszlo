<!-- * X_LZ_COPYRIGHT_BEGIN ***************************************************
* Copyright 2001-2004 Laszlo Systems, Inc.  All Rights Reserved.              *
* Use is subject to license terms.                                            *
* X_LZ_COPYRIGHT_END ****************************************************** -->
<project name="reference" default="build">
  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
  <taskdef name="jing" classname="com.thaiopensource.relaxng.util.JingTask"/>
  <taskdef name="styler" classname="au.com.Langdale.styler.StylerTask"/>
  
  <!-- Local locations for public DTDs, so that the build doesn't
       require web access -->
  <xmlcatalog id="commonDTDs">
    <dtd publicId="-//W3C//DTD XHTML 1.0 Transitional//EN"
         location="dtds/xhtml1-transitional.dtd"/>
  </xmlcatalog>

  <target name="init" description="Init tasks for documentation generation"
          unless="docs.src.done.init">
      <property environment="env"/>                               
      <if><isset property="env.LPS_HOME" /><then>
          <property name="LPS_HOME" value="${env.LPS_HOME}" />
      </then></if>
      <if><not><isset property="LPS_HOME" /></not><then>
          <fail message="LPS_HOME not set" />
      </then></if>
      <if><isset property="env.ANT_HOME" /><then>
          <property name="ANT_HOME" value="${env.ANT_HOME}" />
      </then></if>
      <if><not><isset property="ANT_HOME" /></not><then>
          <fail message="ANT_HOME not set" />
      </then></if>
      
      <property file="${LPS_HOME}/build.properties"/>

      <property name="schema.dir" value="${LPS_HOME}/WEB-INF/lps/schema" />
      <property name="components.dir" value="${LPS_HOME}/lps/components"/>
      <property name="tagdocs.dir" value="${schema.dir}/tagdocs" />
      <property name="server.dir" value="${LPS_HOME}/WEB-INF/lps/server" />
      <property name="sc.dir" value="${server.dir}/sc" />
      <property name="jsdocs.dir" value="${sc.dir}/jsdocs" />
      <property name="lfc.dir" value="${LPS_HOME}/WEB-INF/lps/lfc" />
      <property name="ref.build.dir" value="build" />
      <property name="wrappers.dir" value="wrappers" />
      <property name="lzx-reference.dir" value="${LPS_HOME}/docs/lzx-reference" />
      <property name="tut.build.dir" value="build/tutorials"/>
      <property name="tut.input.dir" value="tutorials"/>
      <property name="tut.output.dir" value="${LPS_HOME}/tutorials"/>
      
      <property name="web.build.dir" value="build/web-intermediate"/>
      <property name="web.output.dir" value="build/web"/>
      <property name="web.support.dir" value="web-doc-support" />

      <property name="docs.src.done.init" value="true" />
  </target>

  <target name="web-clean" depends="init">
    <delete failonerror="false" includeEmptyDirs="true">
      <fileset dir="${web.build.dir}"/>
      <fileset dir="${web.output.dir}"/>
      <fileset dir="${web.support.dir}"/>
    </delete>
  </target>
  
  <target name="web" depends="init">
    <!-- copy one-deep files -->
    <styler>
      <fileset dir=".." includes="*.html" excludes="src/**/*,noship/**/*"/>
      <transform file="xsl/make-php.xsl"/>
      <param name="lpsdir.src" value="../"/>
      <param name="build.branch" value="lps-2.0"/>
      <param name="web.support.dir" value="${web.support.dir}"/>
      <param name="webroot" value="../../../"/>
      <param name="thispage" dir=".">
        <mapper type="glob" from="*.html" to="*.php"/>
      </param>
      <output dir="${web.build.dir}" type="html">
        <mapper type="glob" from="*.html" to="*.php"/>
      </output>
    </styler>
    <!-- copy two-deep files, except tutorials, dguide, and reference -->
    <styler>
      <fileset dir=".." includes="*/*.html" excludes="src/**/*,noship/**/*,tutorials/**/*,developers-guide/**/*,lzx-reference/**/*"/>
      <transform file="xsl/make-php.xsl"/>
      <param name="lpsdir.src" value="../../"/>
      <param name="build.branch" value="lps-2.0"/>
      <param name="web.support.dir" value="${web.support.dir}"/>
      <param name="webroot" value="../../../../"/>
      <param name="thispage" dir=".">
        <mapper type="glob" from="*.html" to="*.php"/>
      </param>
      <output dir="${web.build.dir}" type="html">
        <mapper type="glob" from="*.html" to="*.php"/>
      </output>
    </styler>
    <!-- copy the dguide -->
    <styler>
      <fileset dir=".." includes="developers-guide/*.html"/>
      <transform file="xsl/make-php.xsl"/>
      <param name="lpsdir.src" value="../../"/>
      <param name="build.branch" value="lps-2.0"/>
      <param name="web.support.dir" value="${web.support.dir}"/>
      <param name="webroot" value="../../../../"/>
      <param name="thispage" dir=".">
        <mapper type="glob" from="*.html" to="*.php"/>
      </param>
      <output dir="${web.build.dir}" type="html">
        <mapper type="glob" from="*.html" to="*.php"/>
      </output>
    </styler>
    <!-- copy the tutorials -->
    <styler>
      <fileset dir=".." includes="tutorials/*.html"/>
      <transform file="xsl/make-php.xsl"/>
      <param name="isTutorial" value="true"/>
      <param name="lpsdir.src" value="../../"/>
      <param name="build.branch" value="lps-2.0"/>
      <param name="web.support.dir" value="${web.support.dir}"/>
      <param name="webroot" value="../../../../"/>
      <param name="lxzdir" value="/lps-2.0/docs/tutorials/build"/>
      <param name="thispage" dir=".">
        <mapper type="glob" from="*.html" to="*.php"/>
      </param>
      <output dir="${web.build.dir}" type="html">
        <mapper type="glob" from="*.html" to="*.php"/>
      </output>
    </styler>
    <!-- copy the reference -->
    <styler>
      <fileset dir=".." includes="lzx-reference/*.html"/>
      <transform file="xsl/make-php.xsl"/>
      <param name="isReference" value="true"/>
      <param name="isReference" value="true"/>
      <param name="lpsdir.src" value="../../"/>
      <param name="build.branch" value="lps-2.0"/>
      <param name="web.support.dir" value="${web.support.dir}"/>
      <param name="webroot" value="../../../../"/>
      <param name="thispage" dir=".">
        <mapper type="glob" from="*.html" to="*.php"/>
      </param>
      <output dir="${web.build.dir}" type="html">
        <mapper type="glob" from="*.html" to="*.php"/>
      </output>
    </styler>
    <!-- copy php files -->
    <copy toDir="${web.output.dir}">
      <fileset dir="${web.build.dir}" includes="**/*.php"/>
      <filterset>
        <filter token="VERSIONID" value="${version.id}"/>
      </filterset>
    </copy>
    <!-- Copy lzx, lzo, xm, laszlo-explorer, and assets files -->
    <copy toDir="${web.support.dir}">
        <fileset dir="../.." includes="laszlo-explorer/**/*,docs/**/*.lzx,docs/**/*.lzo,docs/**/*.xml,lps/assets/**/*" excludes="docs/src,docs/src/**/*,docs/noship,docs/noship/**/*"/>
    </copy>
    <!-- Copy non-html files and non-lzx files -->
    <copy toDir="${web.output.dir}">
      <fileset dir=".." excludes="**/*.html,**/*.lzx,**/*.lzo,**/*.in,src/**/*,noship,noship/**/*,**/*.py"/>
    </copy>
    <!-- The welcome page of the product becomes the index of the web ref -->
    <copy file="${web.output.dir}/lzx-reference/welcome.php"
          tofile="${web.output.dir}/lzx-reference/index.php"
          overwrite="true"/>
  </target>
  
  <target name="zip-web-tools" depends="init">
    <delete failonerror="false" file="web-doc-tools.zip"/>
    <zip destfile="web-doc-tools.zip"
         basedir="."
         includes="build.xml,xsl/make-php.xsl"/>
  </target>
  
  <target name="web-zip" depends="init">
    <delete failonerror="false" file="web-docs.zip"/>
    <zip destfile="web-docs.zip"
         basedir="build/web"
         includes="**/*.php"/>
  </target>
</project>
