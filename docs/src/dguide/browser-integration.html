<html xmlns="http://www.w3.org/1999/xhtml" id="browser-integration">
  <head>
    <title>Browser Integration</title>
  </head>

  <body>


<fixme>
The embed tag
    - Mention that the *preferred* way to embed an app in an HTML page
      is to use LzEmbed (see subsequent section).
    - Show cycle of inclusion by requesting a .lzx file, then copying
      HTML source and pasting into your own HTML page.

Communicating with JavaScript
    - Need reverse example (lzSetCanvasAttribute()) in this section.
    - You must use LzEmbed()
    - You must add a lzHistEmbed('/lps-3.0b2'); call in your browser JS.
    - You must use a &lt;method event="onmyattr"&gt; in your canvas
    - You have to use the lzSetCanvasAttribute() method call from
      browser JS.
</fixme>
<h1>Browser Integration</h1>

<p>Though OpenLaszlo applications are not dependent on the browser or
operating system for their look or behavior, there are some
important limitations that the browser container places on the
application. There are also a number of features that your
application can use.
</p>
<h2>Scaling OpenLaszlo Applications to Browser Dimensions</h2>
<p>
You can make the canvas of the OpenLaszlo application either a fixed size, or you can make it expand or contract as the browser window expands or contracts.
To make the canvas an absolute size, set its height and width with integer values, for example, <code>width="40" height="40"</code>. To have the canvas scale, 
simply express the height and width as percentages.</p>
<note>
As of OpenLaszlo release 3.0, the Flash 5 target is no longer supported.  Applications can be compiled for the
Flash 6 or Flash 7 player. The default target is Flash 6.
</note>

<h2>The LzBrowser service</h2>
<p>The <classname link="true">LzBrowser</classname> service provides access to the browser and player environment.
 It includes methods to load URLs in the browser and check the version of the player. Furthermore, by using the <code>LzBrowser</code> service together
with other OpenLaszlo functions described below, you can build applications that pass information and control between the OpenLaszlo application
and the JavaScript of the browser. 
</p>
<p>
As you explore examples
in this chapter you should take the opportunity to explore the facilities provided by this service.
The <code>Lzbrowser</code> is always running.</p>

<!--=========================================================================-->
<!-- embedding applications                                                 -->
<!--=========================================================================-->

<fixme>


&lt;!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
   &lt;head&gt;
      &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;

      &lt;link rel="SHORTCUT ICON" href="http://www.laszlosystems.com/favicon.ico"&gt;
      &lt;title&gt;OpenLaszlo Application&lt;/title&gt;&lt;style type="text/css"&gt;
          html, body { margin: 0; padding: 0; height: 100%; }
          body { background-color: #ffffff; }
        &lt;/style&gt;&lt;/head&gt;
   &lt;body&gt;&lt;object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"
codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,79,0"
data="hello.lzx?lzt=swf" width="500" height="400"&gt;
         &lt;param name="movie" value="hello.lzx?lzt=swf"&gt;

         &lt;param name="quality" value="high"&gt;
         &lt;param name="scale" value="noscale"&gt;
         &lt;param name="salign" value="LT"&gt;
         &lt;param name="menu" value="false"&gt;
         &lt;param name="FlashVars" value="foobar=abcdef&amp;blah=objectred"&gt;
         &lt;param name="bgcolor" value="#ffffff"&gt;
         &lt;embed src="hello.lzx?lzt=swf" quality="high" 
         scale="noscale" salign="lt"
          width="500" height="400" 
          FlashVars="foobar=abcdef&amp;blah=embedblue"
          bgcolor="#ffffff" 
          type="application/x-shockwave-flash" 
          pluginspage="http://www.macromedia.com/go/getflashplayer"&gt;&lt;/embed&gt;&lt;/object&gt;&lt;/body&gt;
&lt;/html&gt;


</fixme>
<h2>Embedding OpenLaszlo Applications</h2>

<p>
OpenLaszlo applications are .swf files sent from the OpenLaszlo Server to be rendered in the Flash Player. They can be from the OpenLaszlo Server to client:
</p>

<ul>
    <li>as "naked" swf </li>
    <li>as swf embedded in an html "wrapper" page</li>
    <li>as xml source.</li>
</ul>

<p>
See <a href="${deploy}/request-types.html">the Request Types chapter of the Deployer's Guide</a> for discussion of the various ways to request applications.
</p>
<p>In this section we'll look at ways to include OpenLaszlo applications in HTML pages.  This means, in effect,
that the HTML page invokes the Flash player, and the player runs the OpenLaszlo application.</p>

<h3>Embedding OpenLaszlo Applications in HTML pages</h3>
<p>
When you place a OpenLaszlo application inside an HTML page, that page has to have some way to know where to place the application, and how to handle it.
That is, you must inform the browser that the embedded OpenLaszlo application is actually a swf file, and so forth.  Necessary information is
included in a file called <code>embed.js</code>, so you need to place a reference to that file within a &lt;script&gt; tag in the head of the HTML file.
In particular, this filed defines the function <code>LzEmbed</code>.
</p>
<p>
You can, of course, put this information into an HTML file "by hand", but the easier way is to use the OpenLaszlo Server to generate a "wrapper" page that 
contains all the necessary information. You can edit this wrapper or paste its contents into an existing HTML page The steps below show how to do this.
</p>
<p>
The easiest way cause the OpenLaszlo Server to generate the appropriate wrapper pages, for both SOLO and proxied applications, is to use the Developer's Console.  Simply press the appropriate button, "Server" or "SOLO", and follow the instructions that are then displayed. 
</p>
<p>
Alternatively, you can generate wrappers by using the various request types on the url you use to browse to your application:
</p>
<ol>
	<li>Invoke the lzx application with request type "?lzt=html". This generates the "wrapper."</li>
	<li>Using your browser's "View source" function, copy the contents of the wrapper and place in a new file with a .html extension.</li>
    <li>In the head of the HTML file, you will see the script tag that includes <code>embed.js</code> Adjust the path if necessary for deployment.</li>
	<li>take lzEmbed method call including surrounding script tags copy that</li>
	<li>paste to wherever you want the OpenLaszlo application to appear in HTML page</li>
<li>verify by running HTML file in your browser.</li>
</ol>
<p>
Consider the following simple OpenLaszlo application. (For now, pay no attention to the <code>onreset</code> method; we'll see it used later.):
</p>
<example title="Hello Grace!">
&lt;canvas height="200" debug="true" proxied="false"&gt;
  &lt;attribute name="reset"/&gt;
  &lt;method event="onreset"&gt;
    redview.unfade.dostart()
    Debug.write('Reset Button clicked')
  &lt;/method&gt;
  &lt;debug y="100"/&gt;
     &lt;view name="redview" bgcolor="red" height="30" width="150" clip="true"&gt;
       &lt;animator name="fade" attribute="opacity" to=".10" duration="2000"/&gt;
       &lt;animator name="unfade" attribute="opacity" to="1" duration="2000" start="false"/&gt;
       &lt;text x="15"&gt; Hello Grace!
         &lt;animator name="wrapper" attribute="x" to="150" duration="2000"/&gt;
       &lt;/text&gt;
     &lt;/view&gt;
&lt;/canvas&gt;
</example>
<p>
The wrapper page returned with by invoking it with the ?lzt=html type returns the following wrapper:
</p>
<example extract="false" title="Simple wrapper page">
&lt;!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
   &lt;head&gt;
      &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
   
      &lt;link rel="SHORTCUT ICON" href="http://www.laszlosystems.com/favicon.ico"&gt;
      &lt;title&gt;OpenLaszlo Application&lt;/title&gt;&lt;style type="text/css"&gt;
      html, body { margin: 0; padding: 0; height: 100%; }
      body { background-color: #ffffff; }
    &lt;/style&gt;&lt;script src="/lps-dev/lps/includes/embed.js" type="text/javascript"&gt;&lt;/script&gt;&lt;/head&gt;
   &lt;body&gt;&lt;script type="text/javascript"&gt;
          lzEmbed({url: 'graceie.lzx?lzt=swf', bgcolor: '#ffffff', width: '500', height: '200'});
        &lt;/script&gt;&lt;/body&gt;

&lt;/html&gt;
</example>
<p>
Later on in this chapter we'll show how to modify this wrapper to enable more sophisticated applications.
</p>

<h3>The <tagname link="false">embed</tagname> tag</h3>

<p>To embed OpenLaszlo applications in HTML pages, you use
<tagname>embed</tagname> tag. The mechanics of this can be handled automatically as we have seen above. For your reference,
here's a sample embed object:</p>

<example extract="false" title="The embed tag">
&lt;object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"
        codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,79,0"
        width="705"
        height="80"&gt;
  &lt;param name="movie" value="OpenLaszloapplication.lzx?lzt=swf"&gt;
  &lt;param name="quality" value="high"&gt;
  &lt;param name="scale" value="noscale"&gt;
  &lt;param name="salign" value="LT"&gt;
  &lt;param name="menu" value="false"&gt;
  &lt;param name="bgcolor" value="#394660"&gt;
  &lt;embed src="OpenLaszloapplication.lzx?lzt=swf" 
         scale="noscale" 
         salign="lt" 
         width="705" 
         height="80" 
         bgcolor="#394660" 
         type="application/x-shockwave-flash" 
         pluginspage="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash"&gt;
  &lt;/embed&gt;
lt;/object&gt;
</example>


<h3>Detecting which flash player is running</h3>
<p>
The default wrapper page contains logic to detect the version of flash running on the client.</p>
<p>
This page that will look something like the following:</p>
<example extract="false" title="Flash player version-detecting wrapper">
&lt;!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
   &lt;head&gt;
      &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
   
      &lt;link rel="SHORTCUT ICON" href="http://www.laszlosystems.com/favicon.ico"&gt;
      &lt;title&gt;OpenLaszlo Application&lt;/title&gt;&lt;style type="text/css"&gt;
      html, body { margin: 0; padding: 0; height: 100%; }
      body { background-color: #ffffff; }
    &lt;/style&gt;&lt;script language="JavaScript1.1" src="/lps-dev/lps/includes/vbembed.js" type="text/javascript"&gt;&lt;/script&gt;&lt;script src="/lps-dev/lps/includes/embed.js" type="text/javascript"&gt;&lt;/script&gt;&lt;/head&gt;
   &lt;body&gt;&lt;script type="text/javascript"&gt;
          actualVersion = detectFlash();
          requiredVersion = 6;
          if (isIE &amp;&amp; isWin || actualVersion &gt;= requiredVersion) {
            lzEmbed({url: 'graceie.lzx?lzt=swf', bgcolor: '#ffffff', width: '500', height: '200'}, requiredVersion);
          } else {
            document.write('This application requires Flash player ' + requiredVersion + '. &lt;a href="http://www.macromedia.com/go/getflashplayer" target="fpupgrade"&gt;Click here&lt;/a&gt; to upgrade.');
          }
        &lt;/script&gt;&lt;/body&gt;

&lt;/html&gt;
</example>

<p>Depending on which version is running, you may wish to use some LZX features that run in some, but not all, versions 
of the Flash Player.</p>
<h4>Version detection</h4>
<p>
OpenLaszlo uses client-side player detection. If the user either a) doesn't have the Flash Player plug-in or b) has an older version, 
they'll be prompted to download a fresh version. This feature is included in the default HTML wrappers for lzt=html and the SOLO 
deployment wizard
</p>
<h4>Features available only in Flash 7 or later </h4>
<p>
The following features are available only in the Flash 7 or later environments:</p>
<ul>
	<li>Support for the html &lt;img&gt; tag</li>
	<li>Support for context ("right-click") menus</li>
</ul>

<h3>How to specify the target</h3>
<p>
The query parameter<code>lzr</code> identifies which version is to be issued.
Use <code>lzr=swf6</code>, <code>lzr=swf7</code>, or <code>lzr=swf8</code> accordingly.
</p>
<p>
Alternatively you can compile your applications using the lzc command. Use the <code>--runtime=</code> 
argument to specify the target, for example,</p>
<pre>
        lzc myfile.lzx --runtime=swf7
</pre>

<h3>Using <method>LzEmbed</method></h3>
<p>LZX provides a number of helpful javascript routines to
simplify the process of embedding LZX applications into your web
pages. The most common of these is lzEmbed, which easily specifies
the application to include and any request parameters that your application relies
on.  LzEmbed is in
<code>/@VERSIONID@/lps/includes/embed.js</code>.</p>

<example extract="false" title="Using LzEmbed">
&lt;script type="text/javascript"&gt;
lzEmbed({url: 'header.lzx?lzt=swf', bgcolor: '#394660', width: '705', height: '80'});
&lt;/script&gt;
</example>

<h2>Page design and layout</h2>
<p><tagname link="false">div</tagname> tags can be used to place applications into various places on your page, 
for example to align your application in the center of a region, 
use:</p>

<example extract="false" title="Using &lt;div&gt; tags to align applications">
&lt;div align="center"&gt;
&lt;script type="text/javascript"&gt;
  lzEmbed({url: 'header.lzx?lzt=swf', bgcolor: '#394660', width: '705', height: '80'});
&lt;/script&gt;
&lt;/div&gt;
</example>

<!--=========================================================================-->
<!-- Integrating applications with frames                                            -->
<!--=========================================================================-->
<h2>Integrating with Frames</h2>
<p>Frames are a very handy way to use OpenLaszlo applications within a
page. If you are using a OpenLaszlo application for your navigation or
as a widget in your page you might consider using frames to lay
things out.</p>

<h3>Frame Sets</h3>
<p>When laying out a page that will use OpenLaszlo applications in
different places, you can use a frameset like this:</p>

<example title="example frameset" extract="false">
&lt;html&gt;
&lt;frameset cols="128,*"&gt;
  &lt;frame name="navBar" src="myOpenLaszloNav.lzx?lzt=html" /&gt;
  &lt;frame name="contentArea" src="myOpenLaszloContent.lzx?lzt=html" /&gt;
&lt;/frameset&gt;
&lt;/html&gt;
</example>

<p>Inside your application use the target parameter of <method>LzBrowser.LoadURL</method> 
to load pages in the target frame.</p>
<example extract="false" title="target in loadURL">
LzBrowser.loadURL('http://www.laszlosystems.com','contentArea');
</example>

<h3>Inline Frames</h3>
<p>Like framesets, OpenLaszlo applications can be embedded within an "inline frame" or  &lt;iframe&gt; which can be more flexible for 
your layout and easier to use. Like regular frames, inline frames can be named for later reference by the OpenLaszlo application.</p>

<example extract="false" title="iframes and applications">
&lt;html&gt;
  &lt;body&gt;
    &lt;h1&gt;Here is a header&lt;/h1&gt;
    &lt;div align="center"&gt;
      &lt;iframe src="myOpenLaszloApplication.lzx?lzt=html" width="200" height="200" 
              frameborder="0" name="inlineApplication" scrolling="no"/&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</example> 

<p>Bear in mind that the iframe will contain a canvas, and unless
you want the browser to provide scrollbars, you should set the width
and height equal to that of your canvas plus any margin you may
have included.</p>

<h3>Popping and reusing browser windows</h3>
<p>The same way you would target content to a frame, you can
target the loadUrl to new window.</p>

<example class="code" title="new Blank window">
&lt;canvas height="27" &gt;
  &lt;button onclick="LzBrowser.loadURL('http://www.laszlosystems.com','_blank');" text="Click Me!"/&gt;
&lt;/canvas&gt;
</example>

<p>This mechanism can also be used to name the window allowing subsequent loads to occur in the same window</p>

<example class="code" title="new Blank window">
&lt;canvas height="56" &gt;
  &lt;simplelayout/&gt;
  &lt;button onclick="LzBrowser.loadURL('http://www.openlaszlo.org','newOpenLaszloWindow');" text="OpenLaszlo Homepage"/&gt;
  &lt;button onclick="LzBrowser.loadURL('http://www.mylaszlo.com','newOpenLaszloWindow');" text="myLaszlo.com"/&gt;
&lt;/canvas&gt;
</example>

<!--=========================================================================-->
<!-- Passing variables to Laszlo Applications                                        -->
<!--=========================================================================-->
<h2>Passing startup Data to Embedded Applications</h2>
<p>Any query parameters that you add to the end of your url to load
the application get passed into the application as globals.</p>

<example extract="false" title="Passing query parameters to LZX application">
&lt;script type="text/javascript"&gt;
lzEmbed({url: 'header.lzx?lzt=swf&amp;globalVar=foo', bgcolor: '#394660', width: '705', height: '80'});
&lt;/script&gt;     
</example>

<h3>Query Parameters and Global Variables</h3>
<p>Once the data has been passed in you can simply access it as a
global variable from within the OpenLaszlo application.</p>

<example extract="false" title="Accessing parameters">
&lt;canvas debug="true" oninit="Debug.write(globalVar)"/&gt;       
</example>    

<p>In many cases you will have full control of the HTML content
that is embedding your application. In many other cases you won't be able
to depend on the existence of those query parameters so it is wise
to provide sane defaults for those values:</p>

<example title="Setting defaults"
     filename="browser-integration.setting-defaults.lzx">
&lt;canvas debug="true" width="200" height="200"&gt;
  &lt;script&gt;
    var innerVar = typeof(global.globalVar) != 'undefined' ? global.globalVar : 'bar';
    Debug.write(global.innerVar);
  &lt;/script&gt;
&lt;/canvas&gt;
</example>

<p>The above application is requested without a <code>globalVar</code>
query parameter.  The debugger therefore displays the default
value <code>bar</code>.  If this application is requested with the
<code>globalVar=foo</code> query parameter, it will display the
default value 'bar'. Click <a href="#"
onclick="javascript:window.open('programs/browser-integration.setting-defaults.lzx?lzt=swf&amp;globalVar=foo','example','resizable=0,width=200,height=200,menubar=0,location=0,status=0,scrollbars=0,toolbar=0,address=0')">here</a>
to see the application in a popup window with the this query
parameter applied.</p>

<h3>Application state</h3>
<p>Using query parameters, you can craft your application to start
up in a specific state. The default behavior of a tabslider is to
have none of the tabelements opened at startup. The following
application changes that default to open to the tab specified on the query parameter,
and if one isn't provided, open to the first element.</p>

<example title="Restoring state" filename="browser-integration.restoring-state.lzx">
&lt;canvas width="300" height="250"&gt;
  &lt;script&gt;
    var opened = typeof(global.tab) != 'undefined' ? global.tab : 'one';
  &lt;/script&gt;
  &lt;tabslider width="150" x="10" y="10"
             height="200"
             spacing="2" slideduration="300" oninit="this[global.opened].setAttribute('selected',true)"&gt;
    &lt;tabelement name="one" text="Tabelement One"/&gt;
    &lt;tabelement name="two" text="Tabelement Two"/&gt;
    &lt;tabelement name="three" text="Tabelement Three"/&gt;
  &lt;/tabslider&gt;
&lt;/canvas&gt;
</example>

<p>Click <a href="#"
onclick="javascript:window.open('programs/browser-integration.restoring-state.lzx?lzt=swf&amp;tab=two','example','resizable=0,width=200,height=250,menubar=0,location=0,status=0,scrollbars=0,toolbar=0,address=0')">here</a>
to see this application in a popup with a different initial state
applied. This is useful when creating links from outside the
application, or for creating a bookmark for an
application. Another thing to do is read browser cookies from
javascript and pass in the parameters when calling
<method>LzEmbed</method>.</p>

<!--=========================================================================-->
<!-- Multi Resolution applications                                                   -->
<!--=========================================================================-->
<h2>Supporting Multiple Resolutions</h2>
<p>Most web surfers have discovered the merits of high resolution
displays. Some, though, still view the web using very low
resolutions. OpenLaszlo applications can be written in a way that allows for
multiple resolution versions of the same application to coexist using the
same codebase.</p>

<p>Begin by creating your application in a library file instead of a
canvas, but use <code>$once{}</code> constraints to size the
visual elements relative to the canvas.</p>

<example title="Multi-canvas application library" extract="false">
mainApplication.lzx:
&lt;library&gt;
  &lt;tabslider width="$once{canvas.width - 20}" x="10" y="10"
             height="$once{canvas.height - 20}"
             spacing="2" slideduration="300"&gt;
    &lt;tabelement name="one" text="Tabelement One"/&gt;
    &lt;tabelement name="two" text="Tabelement Two"/&gt;
    &lt;tabelement name="three" text="Tabelement Three"/&gt;
  &lt;/tabslider&gt;
&lt;/library&gt;
</example>

<p>Then create multiple files, one for each canvas area you wish
to support.</p>

<example title="Multi-canvas application files" extract="false">
mainApplication640.lzx:
&lt;canvas width="640" height="480"&gt;
  &lt;include href="mainApplication.lzx"/&gt;
&lt;/canvas&gt;

mainApplication800.lzx:
&lt;canvas width="800" height="600"&gt;
  &lt;include href="mainApplication.lzx"/&gt;
&lt;/canvas&gt;

mainApplication1024.lzx:
&lt;canvas width="1024" height="768"&gt;
  &lt;include href="mainApplication.lzx"/&gt;
&lt;/canvas&gt;

mainApplication1280.lzx:
&lt;canvas width="1280" height="1024"&gt;
  &lt;include href="mainApplication.lzx"/&gt;
&lt;/canvas&gt;
</example>

<p>For real world deployments, you will want to set the size of
your canvas to account for screen area occupied by browser
controls.  Selecting the correct application size
requires some javascript to pick the right application when the visitor
comes to the page. This example keys off the screen width which
will help you determine with high accuracy the height of the
client as well.</p>

<example title="Using LzEmbed() to Selecting the Correct Canvas" extract="false">
&lt;script type="text/javascript"&gt;
var screenW = screen.width;
var screenH =0;
switch (true) {
  case (screenW &gt;= 1280):
    screenW = 1280;
    screenH = 1024;
    break;
  case (screenW &gt;= 1024):
    screenW = 1024;
    screenH = 768;
    break;
  case (screenW &gt;= 800):
    screenW = 800;
    screenH = 600;
    break;
  default:
    screenW = 640;
    screenH = 480;
    break;         
}
lzEmbed({url: 'mainApplication'+screenW+'.lzx?lzt=swf', bgcolor: '#394660', width: screenW, height: screenH});        
&lt;/script&gt;  
</example>

<!--=========================================================================-->
<!-- Communicating with JavaScript                                           -->
<!--=========================================================================-->

<h2>Communicating with Javascript</h2>

<p>
It is possible to pass initialization arguments in by adding arguments to the <method>lzEmbed</method> call in 
the wrapper HTML or by adding them to the query string when you request your app from the server.
</p>
<p>
If you define attributes on the canvas with a 
corresponding name and no value, these attributes will be set when your application starts up. 
</p>
<p>
For example, adding this in the canvas of your app:
</p>
<pre>
        &lt;attribute name="foo" /&gt;
</pre>
<p>
Allows the value of foo to be passed in via lzEmbed in the HTML, e.g.:
</p>
<pre>

    lzEmbed({url: 'grad_test.lzx?lzt=swf&amp;foo=bar', bgcolor: '#ffffff', width: '800', height: '600'});
</pre>
<p>
would cause the foo attribute to contain 'bar' when the application starts up.
</p>
<h3>Bidirectional Communication</h3>
<p>
The <classname>LzHistory</classname>service allows you to establish bidirectional communication between the browser and the OpenLaszlo application.
When you deploy your OpenLaszlo application with the the default wrapper,it includes the javascript
functions that enable this.  
</p>
<p>
After the application has been loaded, the methods of communication are as follows:</p>
<ul>
	<li>From OpenLaszlo application to browser, use the <method>loadURL</method> of the <classname>LzBrowser</classname> service</li>
	<li>From browser to the OpenLaszlo application, use <tt>LzSetCanvasAttribute()</tt></li>
</ul>
<p>
Any attributes that are declared on the canvas are visible to the browser javascript.
You use the function <code>lzSetCanvasAttribute</code> to pass information from the browser to the application.
</p>
<p>
Here's a wrapper page that uses these methods to communicate with the "Hello Grace" example from the beginning of this 
chapter. When you click the button, it sets the global variable called 'reset' in the OpenLaszlo application.</p>
<example title="bidirectional application wrapper" extract="false">

&lt;!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
   &lt;head&gt;
      &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
   
      &lt;link rel="SHORTCUT ICON" href="http://www.laszlosystems.com/favicon.ico"&gt;
      &lt;title&gt;OpenLaszlo Application&lt;/title&gt;&lt;style type="text/css"&gt;
      html, body { margin: 0; padding: 0; height: 100%; }
      body { background-color: #ffffff; }
    &lt;/style&gt;&lt;script src="/lps-dev/lps/includes/embed.js" type="text/javascript"&gt;&lt;/script&gt;&lt;/head&gt;
   &lt;body&gt;&lt;script type="text/javascript"&gt;
            lzEmbed({url: 'graceie.lzx?lzt=swf&amp;__lzhistconn='+top.connuid+'&amp;__lzhisturl=' + escape('/lps-dev/lps/includes/h.html?h='), bgcolor: '#ffffff', width: '500', height: '300'});
            lzHistEmbed('/lps-dev');
        &lt;/script&gt;
    &lt;form&gt;
    &lt;input type="button" onclick="lzSetCanvasAttribute('reset', true)" value="Reset"/&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;

</example>

<h4>Example: building a URL</h4>
<p>
In this example, notice how the <method>LzBrowser.loadURL()</method> method is used
to create a URL based on user input.  This URL is then communicated to browser, where a javascript function is 
used to unpack it and fill in a form. The wrapper page is shown immediately below.
</p>
<example name="Using loadURL to pass information" extract="false">
&lt;canvas width="200" height="400"&gt;
    &lt;attribute name="appear" type="number" value="0" /&gt;
    &lt;method event="onappear"&gt;
        win.show.doStart();
    &lt;/method&gt;

    &lt;window id="win" title="Create and Account" 
            y="-300"
            width="180" height="300"&gt;
        &lt;animator name="show" attribute="y" from="-300" to="50" 
                  start="false" relative="false" duration="500" /&gt;
        &lt;animator name="hide" attribute="y" from="50" to="-300" 
                  start="false" relative="false" duration="500" /&gt;
        &lt;simplelayout axis="y" spacing="4" /&gt;
         
        &lt;state name="question" apply="true"&gt;
            &lt;text multiline="true" width="160" align="center"&gt;
                It looks like you don't have an account. Would you 
                like to create one now?
            &lt;/text&gt;
            &lt;button&gt;Go
                &lt;method event="onclick"&gt;
                    parent.question.remove();   
                    parent.signup.apply();
                &lt;/method&gt;
            &lt;/button&gt;
        &lt;/state&gt;
        &lt;state name="signup"&gt;
            &lt;text&gt;Name:&lt;/text&gt;
            &lt;edittext /&gt;
            &lt;text&gt;Email:&lt;/text&gt;
            &lt;edittext /&gt;
            &lt;text&gt;Username:&lt;/text&gt;
            &lt;edittext name="uname"/&gt;
            &lt;text&gt;Password:&lt;/text&gt;
            &lt;edittext name="pass" /&gt;
            &lt;button&gt;Create Account
                &lt;method event="onclick"&gt;
                    var s = "javascript:fillFormValues('"
                          + parent.uname.getText()
                          + "', '" + parent.pass.getText()
                          + "')";
                    LzBrowser.loadURL(s);
                    parent.hide.doStart();
                &lt;/method&gt;
            &lt;/button&gt;
        &lt;/state&gt;
    &lt;/window&gt;    
&lt;/canvas&gt;
</example>
<p>
Here is a sample wrapper that was generated by </p>
<ol>
	<li>running the program with the ?lzt=history query</li>
	<li>saving the wrapper by copying from "view source" and pasting to .html file</li>
	<li>editing the wrapper with the logic for the button and unpacking name and password</li>
</ol>

<example title="Wrapper for login example application" extract="false">
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Login Form&lt;/title&gt;
    &lt;script type="text/javascript" src="/lps-3.0b2/lps/includes/embed.js"&gt;&lt;/script&gt;
    &lt;script&gt;
        function fillFormValues( uname, pass ) {
            document.forms[0].u.value = uname;
            document.forms[0].p.value = pass;
        }
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Login Form&lt;/h1&gt;

&lt;table&gt;
&lt;tr&gt;
    &lt;td width="200"&gt;
        &lt;p&gt;
            Please enter your username and password below. If you don't have a username and password, you will be prompted to create an account.
        &lt;/p&gt;
        &lt;form name="f" action="" onsubmit="lzSetCanvasAttribute('appear', 1); return false; return false"&gt;
            Username:&lt;br&gt;
            &lt;input name="u" type="text"&gt;&lt;br&gt;
            Password&lt;br&gt;
            &lt;input name="p" type="password"&gt;&lt;br&gt;
            &lt;input type="submit" value="Log In"&gt;
        &lt;/form&gt;
    &lt;/td&gt;
    &lt;td&gt;
    
            &lt;script type="text/javascript"&gt;
lzEmbed({url: 'createaccount.lzx?lzt=swf&amp;__lzhistconn='+top.connuid+'&amp;__lzhisturl=' + escape('/lps-3.0b2/lps/includes/h.html?h='), bgcolor: '#ffffff', width: '200', height: '400'});
            lzHistEmbed('/lps-3.0b2');
          &lt;/script&gt;
    &lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;

&lt;/body&gt;
&lt;/html&gt;

</example>
<h3>Passing Parameters to SOLO applications</h3>
<p>
If you are deploying a SOLO application and wish to pass parameters down to the application from the base URL, you need to make some
 modifications to the stock html wrapper page that the server provides. 
</p>
<p>
Here is an <code>lzEmbed</code> line that passes all of the query parameters down to the Laszlo app undamaged:</p>
<pre>
lzEmbed({url: 'main.lzx.swf?'+window.location.search.substring(1), bgcolor: '#ffffff', width: '100%', height: '100%'});
</pre>
<p>

The thing that's different is the alteration to <code>main.lzx.swf? </code>from <code>main.lzx?lzt=swf</code> and the addition of 
<code>'+window.location.search.substring(1)'</code>
</p>
<h2>Using the browser's "back" button</h2>
<p>
The <classname>LzHistory</classname> service allows you to preserve the state of your application, and then use the "back" button of the 
browser to move among such states.
</p>
<p>
The default wrapper page 
enables the 
back button and browser-to-LZX communication.  Once you've  got this, you can call the browser javascript method 
</p>
<pre>
        javascript:lzSetCanvasAttribute(attributeName, value)
</pre> 
<p>
to set a canvas attribute and send an event.  The following example shows the way the <classname>LzHistory</classname> service works
to move among states.  To see the program in action, copy this code to your applications directory.

</p>
<example extract="false" title="Communicating with Back button">
&lt;canvas width="1400" height="600" debug="true"&gt;
  &lt;debug width="500" height="500" fontsize="12" x="450"/&gt;

  &lt;!-- Click on blob START, STATE_2, STATE_3, END, then click browser back button --&gt;

  &lt;!-- a blob you can click on to select --&gt;
  &lt;class name="blob" extends="drawview" width="100" height="100"&gt;
    &lt;attribute name="title" type="text"/&gt;
    &lt;attribute name="selected" type="boolean" /&gt;
    &lt;text y="20" x="4" fontsize="16" text="${parent.title}"/&gt;
    &lt;method event="onclick"&gt;
      this.setAttribute('selected', true);
      main.selectBlob(this);
    &lt;/method&gt;

    &lt;method name="select" args="val"&gt;
      if (val) {
      // draw a border to select
        this.lineStyle = 0x000000;
        this.lineWidth = 4;
        moveTo(0,0);
        lineTo(0,100);
        lineTo(100,100);
        lineTo(100,0);
        lineTo(0,0);
        stroke();
      } else {
          clear();
      }
    &lt;/method&gt;

  &lt;/class&gt;

  &lt;!-- A view with four states --&gt;
  &lt;view id="main" x="10" y="10"  layout="axis: x; spacing: 10"&gt;
    &lt;attribute name="mystate" type="string" value="START"/&gt;

    &lt;blob bgcolor="#ffcccc" id="s1" title="START"/&gt;
    &lt;blob bgcolor="#ccccff" id="s2" title="STATE_2"/&gt;
    &lt;blob bgcolor="#ccffcc" id="s3" title="STATE_3"/&gt;
    &lt;blob bgcolor="#cccccc" id="s4" title="END"/&gt;

    &lt;method name="unselectAll"&gt;
      s1.select(false);
      s2.select(false);
      s3.select(false);
      s4.select(false);
    &lt;/method&gt;

    &lt;method name="selectBlob" args="blob"&gt;
       <em>// save the old state
     LzHistory.next();</em>
      setAttribute('mystate', blob.title);
      unselectAll();
      blob.select(true);
      recordState(blob.title);
    &lt;/method&gt;

    &lt;method event="oninit"&gt;
      unselectAll();
      recordState("START");
      selectBlob(s1);
    &lt;/method&gt;

    &lt;method event="onmystate"&gt;
      Debug.write("got onmystate event: ", this.mystate);
      gotoState(this.mystate);
    &lt;/method&gt;

    &lt;method name="recordState" args="newstate"&gt;
      this.mystate = newstate;
     <em> LzHistory.save(this,'mystate', this.mystate);</em>
      Debug.write("recordState", newstate)
    &lt;/method&gt;

    &lt;method name="gotoState" args="ns"&gt;
      unselectAll();
      if (ns == "START") {
          s1.select(true);
      } else if (ns == "STATE_2") {
          s2.select(true);
      } else if (ns == "STATE_3") {
          s3.select(true);
      } else if (ns == "END") {
          s4.select(true);
      }
    &lt;/method&gt;
  &lt;/view&gt;

&lt;/canvas&gt;

</example>

<!--=========================================================================-->
<!-- Browser Imposed limitations & caveats                                   -->
<!--=========================================================================-->
<h2>Browser Limitations</h2>
<p>Intercepting keystrokes can pose some challenges.  The keys
that are intercepted varies from browser to browser, but anything
that the browser defines will not be passed to your OpenLaszlo
application. Mozilla Firefox seems to do this correctly, but many
browsers won't pass alt and ctrl key combinations down to the application. The
application below should demonstrate this, [Ctrl-n] in many browsers is
the command you use to open a new browser window. In Mozilla
Firefox, you can get the debugger to print the right message, but
only if your mouse is floating over the application.</p>

<example>
&lt;canvas height="130" debug="true"&gt;
  &lt;command oninit="this.setKeys(['Control','n'])"
           onselect="Debug.write('the [Ctrl-n] key combination was pressed');" /&gt;
&lt;/canvas&gt;
</example>

<fixme>Safari caching info goes here</fixme>
<fixme>
not all browsers support transparency of flash over html.  In those cases changing the background color has no effect.
canvas transparent by default -- so bgcolor should be respected by rendering browser. Default bgcolor comes from canvas, if set.
Two classes of browsers
-- active x
-- plug ing

Windows browsers often active x exception is open source mozilla(s)

Active X -- uses object tag
others use embed tag

so, "Wrapper"  page must include info for BOTH types.

Esoteric combinations exist, but we generate code for general cases.

what we send depends on request type. If lzt=swf then we just send swf.  Else, we send and html page (of some form -- link to chapter on lps request types.)

</fixme>
<fixme>
Henry's history example

</fixme>
      <!--=========================================================================-->
      <!-- Flash version issues                                                    -->
      <!--=========================================================================-->
      <?ignore
      <fixme/>
    <h2>Flash Plugin stuff</h2>
    <ul>
      <li>why flash versioning matters
        <ul>
          <li>For bonanza, only need to guarantee that fp5 or greater is there</li>
          <li>But later we will have a host of other reasons to request fp6.</li>
          <li>fp5 on linux is really unusably slow</li>
          <li>Often flas version is irrelevant</li>
        </ul>
      </li>
      <li>internationalized applications</li>
      <li>other flash 6 features</li>
      <li>other flash 7 features</li>
      <li>how to detect flash version</li>
      <li>what to do with this info:  what kind of options the programmer has for deploying to different flash clients</li>
    </ul>

    <!-- Here is a list of some topics you may want to discuss in this chapter-->
    <fixme>
      If you set the noscale option, then the application can adapt to its browser size.  One application could be embedded in multiple pages at different sizes, then you could layout content differently depending on canvas dimensions.

      If you want it to be dynamic at runtime (e.g. using embed/object tag w/ width/height = 100%), we would need to expose stage._width and stage._height.  In Flash 6, there's ActionScript to get notified when properties change.

      --I need to get this info from sarah on how all this will be exposed for Bonanza
    </fixme>

    <fixme>
      .     single-threaded-ness but re-entrance possible
      .     when might your code be interrupted?
      .     need to avoid script that takes more than frametime (which is typically 30fps)
      .     affects of imported swf frame rates on application framerate
      LzURL
    </fixme>


    <p>
      Anything else that an application developer or deployer might need to be aware of that has to do with
      ** which browser the application will run in
      ** which flash version the application will run in
    </p>

    
    
    <h2> Memory leaks in Flash</h2>
    <h3>I don't believe that this actually belongs in this chapter...</h3>
    <p>
      As we have a number of bugs filed against memory leaks caused by
      specific LFC components, and this is a recurring subject of Dev list
      threads, I can't help but wonder about a few things in this regard.
    </p>
    <p>
      1. First of all, what do we consider a memory leak? If you run an application
      for a while and its memory footprint grows and never comes down to its
      original level, does that necessarily indicate a leak in our libraries?
      Or is a leak defined as delta between the memory size of the browser
      before and after a Flash application was loaded then unloaded?
    </p>
    <p>
      2. If Flash is very much like Java/Perl/Python etc. as far as memory
      management is concerned, then I don't quite see how application
      developers (specifically, Laszlo) could be blamed for the lazy nature of
      garbage collection which they have no control over whatsoever. The only
      case you'd need to be careful about is making sure there are no circular
      references in the code, i.e.
    </p>
    <pre class="code">
 var a = new Object()
 var b = new Object()
 a.foo = b
 b.foo = a
    </pre>
    <fixme>

      ** need to find out from max what will make it in for bonanza... ask and ye shall receive
      Emerald
        Version detection
        canvas resizeability (mx Stage version)
        embedargs method
        For passing args in without using query string/busting
        cache
        sharedobjects?

      (Time allowing, if possible)
      Browser cooke set/get
      Frames back button support

      Future
      Back button, other MX-required features 
    </fixme>
<fixme>
from the wrapper page
Deploying This Application

Using the HTML Wrapper

The simplest way to deploy an application is to use the  html request type. This generates an HTML page  that uses the JavaScript embed.js library to embed the application. Unlike the development page (with no request  type), it does not display the developer console and compiler  warnings.

 View the result of the HTML deployment page here.  (Note that this page is generated dynamically in the browser,  adapting to the particular browser's capabilities, so the  browser source view is not equivalent to the HTML deployment  page source.)

 Deployment with an Embedded object Tag

 The application can also be embedded within a page that does  not use the JavaScript library. This can be a good choice if you  expect many clients to have JavaScript disabled in their  browser.

 View the HTML page with the embedded object tag here.  (Note that while this page is generated dynamically by the  server, adapting to the particular browser's capabilities, only  Internet Explorer on Windows gets special treatment; the code  generated for all other browsers is XHTML 1.0 compliant. The  code generated for Internet Explorer on Windows uses proprietary  extensions to ensure that the correct version of the Flash  plug-in is installed. Internet Explorer on Windows can also display the XHTML 1.0 version, so if you need to embed your  application into a larger static page, you should use the XHTML  1.0 version.)

 To deploy using static XHTML 1.0 compliant code, place the  following in your HTML document where the Laszlo application  should appear:
&lt;object type="application/x-shockwave-flash"
        data="graceie.lzx?lzt=swf"
        width="500" height="400"&gt;
  &lt;param name="movie" value="graceie.lzx?lzt=swf" /&gt;
  &lt;param name="quality" value="high" /&gt;
  &lt;param name="scale" value="noscale" /&gt;
  &lt;param name="salign" value="LT" /&gt;
  &lt;param name="menu" value="false" /&gt;
&lt;/object&gt;

 Deployment with the JavaScript embed.js Library

 To deploy using the JavaScript embed.js library,  place the following line within the <head>  section of the HTML document that embeds the Laszlo  application:
&lt;script src="/lps-dev/lps/includes/embed.js" type="text/javascript"&gt;&lt;/script&gt;

 Place the following element within the &lt;body&gt;  section of the document, at the location where the Laszlo  application should appear:
&lt;script type="text/javascript"&gt;
          lzEmbed({url: 'graceie.lzx?lzt=swf', bgcolor: '#ffffff', width: '500', height: '400'});
&lt;/script&gt;

 Click here to see an example deployment page.

 You can also use the js request type to generate  the call to lzEmbed:
&lt;script src="graceie.lzx?lzt=js" type="text/javascript"&gt;
&lt;/script&gt;

 If the HTML page is moved to a different directory than the  lzx source file, the value of the 'url' parameter will need to  be changed.

 Deploying a Kranked Application

To use the Kranked version of an application, replace  graceie.lzx above by  graceie.lzo. See the Krank  chapter of the LZX  Developers' Guide for more information about the Krank  feature.

 To use the kranked version if it is available, and compile an  unkranked application otherwise, replace graceie.lzx above by graceie.lzo?fb=1.

 Scaling and Cropping

To crop the application to the width and height, add  scale: 'noscale' to the list of arguments to  lzEmbed above. Otherwise the application will be  scaled.

 More Information
	 	Deployer's Guide
	 	Request Types
	 	Developer Network
	 	Developer Forums
</fixme>
?>

  </body>
</html>
<!-- * X_LZ_COPYRIGHT_BEGIN ***************************************************
* Copyright 2001-2006 Laszlo Systems, Inc.  All Rights Reserved.              *
* Use is subject to license terms.                                            *
* X_LZ_COPYRIGHT_END ****************************************************** -->
